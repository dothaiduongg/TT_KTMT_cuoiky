#include <reg51.h>
#include <intrins.h>
#include <string.h>
#include <stdio.h>
sbit SRCLK = P3 ^ 6;
sbit RCLK = P3 ^ 5;
sbit SER = P3 ^ 4;

unsigned int flag = 0;  //dat
unsigned char re_Data;
unsigned char dt[45];


int i;

#define COMMONPORTS P0

unsigned int count = 0;
unsigned char code TAB[] = { 0x7f, 0xbf, 0xdf, 0xef, 0xf7, 0xfb, 0xfd, 0xfe };  //
unsigned char led[][8] = { 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 };
unsigned char code CHARCODE[][8] = {
  { 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 },  /*space*/
  { 0x00, 0x7C, 0x82, 0x82, 0x82, 0x7C, 0x00, 0x00 },  //0 //
  { 0x00, 0x00, 0x08, 0x84, 0xFE, 0x80, 0x00, 0x00 },  //1 //
  { 0x00, 0x00, 0x64, 0x52, 0x4A, 0x44, 0x00, 0x00 },  //2 //
  { 0x00, 0x00, 0x82, 0x92, 0x92, 0x6C, 0x00, 0x00 },  //3 //
  { 0x00, 0x00, 0x10, 0x18, 0x14, 0x7E, 0x10, 0x00 },  //4 //
  { 0x00, 0x00, 0x8C, 0x94, 0x94, 0x64, 0x00, 0x00 },  //5
  { 0x00, 0x00, 0x7C, 0x92, 0x92, 0x64, 0x00, 0x00 },  //6
  { 0x00, 0x00, 0x02, 0x02, 0x12, 0xFE, 0x10, 0x00 },  //7 //
  { 0x00, 0x00, 0x6C, 0x92, 0x92, 0x6C, 0x00, 0x00 },  //8 //
  { 0x00, 0x00, 0x8C, 0x92, 0x92, 0x7C, 0x00, 0x00 },  //9 //
  { 0x00, 0xF8, 0x14, 0x12, 0x14, 0xF8, 0x00, 0x00 },  //A //
  { 0x00, 0x00, 0xFE, 0x92, 0x92, 0x6C, 0x00, 0x00 },  //B
  { 0x00, 0x00, 0x7C, 0x82, 0x82, 0x82, 0x00, 0x00 },  //C
  { 0x00, 0x00, 0xFE, 0x82, 0x82, 0x7C, 0x00, 0x00 },  //D
  { 0x00, 0x00, 0xFE, 0x92, 0x92, 0x92, 0x00, 0x00 },  //E
  { 0x00, 0x00, 0xFE, 0x12, 0x12, 0x12, 0x00, 0x00 },  //F
  { 0x00, 0x00, 0x7C, 0x82, 0x92, 0x72, 0x10, 0x00 },  //G
  { 0x00, 0x00, 0xFE, 0x10, 0x10, 0xFE, 0x00, 0x00 },  //H //
  { 0x00, 0x00, 0x82, 0x82, 0xFE, 0x82, 0x82, 0x00 },  //I //
  { 0x00, 0x00, 0x82, 0x82, 0x7E, 0x02, 0x00, 0x00 },  //J //
  { 0x00, 0xFE, 0x10, 0x28, 0x44, 0x82, 0x00, 0x00 },  //K
  { 0x00, 0xFE, 0x80, 0x80, 0x80, 0x80, 0x00, 0x00 },  //L
  { 0x00, 0x00, 0xFE, 0x04, 0x08, 0x04, 0xFE, 0x00 },  //M //
  { 0x00, 0x7E, 0x04, 0x08, 0x10, 0x7E, 0x00, 0x00 },  //N
  { 0x00, 0x00, 0x78, 0x84, 0x84, 0x84, 0x78, 0x00 },  //O //
  { 0x00, 0xFE, 0x12, 0x12, 0x12, 0x0C, 0x00, 0x00 },  //P
  { 0x00, 0x3E, 0x42, 0x42, 0x62, 0x7C, 0x80, 0x00 },  //Q
  { 0x00, 0xFE, 0x12, 0x32, 0x52, 0x8C, 0x00, 0x00 },  //R
  { 0x00, 0x8C, 0x92, 0x92, 0x62, 0x00, 0x00, 0x00 },  //S
  { 0x00, 0x00, 0x02, 0x02, 0xFE, 0x02, 0x02, 0x00 },  //T //
  { 0x00, 0x00, 0x7E, 0x80, 0x80, 0x80, 0x7E, 0x00 },  //U //
  { 0x00, 0x00, 0x3E, 0x40, 0x80, 0x40, 0x3E, 0x00 },  //V //
  { 0x00, 0x00, 0xFE, 0x40, 0x20, 0x40, 0xFE, 0x00 },  //W //
  { 0x00, 0x42, 0x24, 0x18, 0x18, 0x24, 0x42, 0x00 },  //x //
  { 0x00, 0x00, 0x02, 0x04, 0xF8, 0x04, 0x02, 0x00 },  //Y //
  { 0x00, 0x42, 0x62, 0x52, 0x4A, 0x46, 0x42, 0x00 },  //Z //
  { 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 },

};
//Loi chu cai bi nguoc
unsigned char character[] = { { ' ' }, { '0' }, { '1' }, { '2' }, { '3' }, { '4' }, { '5' }, { '6' }, { '7' }, { '8' }, { '9' }, 
{ 'A' }, { 'B' }, { 'C' }, { 'D' }, { 'E' }, { 'F' }, { 'G' }, { 'H' }, { 'I' }, { 'J' }, { 'K' }, { 'L' }, { 'M' }, { 'N' }, 
{ 'O' }, { 'P' }, { 'Q' }, { 'R' }, { 'S' }, { 'T' }, { 'U' }, { 'V' }, { 'W' }, { 'X' }, { 'Y' }, { 'Z' }, { ' ' } };
void delay(int cnt) {
  while (cnt--)
    _nop_();
}

void serial_init(void) {
  TMOD = 0x20;  //timer1, 8bit
  TH1 = 0xFA;
  SCON = 0x50;  //serial use timer 1, receive enable
  TR1 = 1;      //start timer 1

  EA = 1;
  ES = 1;
}

void serial_send(unsigned char a) {
  SBUF = a;
  while (TI == 0)
    ;
  TI = 0;
}

void serial_ISR(void) interrupt 4 {
  if (RI == 1) {
    re_Data = SBUF;
    dt[count] = re_Data;
    count++;
    RI = 0;
    flag = 1;
    delay(10);
  }
}

void shiftOut74HC595(char x) {
  int i;
  for (i = 0; i < 8; i++) {
    if (x & (1 << i)) {
      SER = 1;
    } else {
      SER = 0;
    }
    SRCLK = 1;
    SRCLK = 0;
  }
}

void hienChu(unsigned char code chayChu[][8]) {

  for (i = 0; i < 8; i++) {
    RCLK = 0;
    shiftOut74HC595(chayChu[0][i]);
    COMMONPORTS = TAB[i];
    delay(80);
    //delay(100000);
    RCLK = 1;
  }
}

void chay1Chu(unsigned int tocDo, unsigned int soKyTu) {
  int h, z, w;
  for (h = 0; h < 8; h++) {
    for (z = 0; z < 7; z++) {
      led[0][z] = led[0][z + 1];
    }
    led[0][7] = CHARCODE[soKyTu][h];
    for (w = 0; w < tocDo; w++) {
      hienChu(led);
    }
  }
}

void quetChu(char *hienthi) {
  int q, e;
  for (q = 0; q < strlen(hienthi); q++) {
    for (e = 0; e < sizeof(character) - 1; e++) {
      if (hienthi[q] == character[e]) {
        chay1Chu(10, e);
        if (q == strlen(hienthi) - 1) {
          chay1Chu(10, 37);
        }
        break;
      }
    }
  }
}
void main() {
  //unsigned int i;
  serial_init();
  while (1) {
    if (flag == 1) {
      delay(50);
      serial_send('O');
      quetChu(&dt);
      count = 0;
      //serial_send('K');
      flag = 0;
    }
    //quetChu(" A B C D E F G H I J K L M N O P Q R S T U V W X Y Z 1 2 3 4 5 6 7 8 9", 10);
  }
}